#' Plot minimum spanning tree (MST)
#' 
#' Plot minimum spanning tree (MST) from FlowSOM clustering, with optional color shading 
#' to represent differential testing results
#' 
#' Creates a minimum spanning tree (MST) plot, which shows the relationship between
#' clusters generated by FlowSOM.
#' 
#' The \code{type} argument specifies the type of MST plot to generate. In each case,
#' point sizes are also scaled to represent the total number of cells per cluster. Options
#' are:
#' \itemize{
#' \item \code{basic} Basic MST plot without any differential testing results.
#' \item \code{DA} MST plot with shading to represent results from tests for differential
#' abundance (DA) of clusters.
#' \item \code{DE} MST plot with shading to represent results from tests for differential
#' expression (DE) of functional markers within clusters.
#' }
#' 
#' 
#' @param d_se Data object from \code{\link{generateClusters}}, which contains the minimum
#'   spanning tree (MST) information from the FlowSOM clustering algorithm.
#' 
#' @param d_counts Data object from \code{\link{calcCounts}}, which contains the number of
#'   cells per cluster.
#' 
#' @param res_DA Results object from \code{\link{testDA}}, which contains the DA testing
#'   results. Required if \code{type = DA}. Default = NULL.
#' 
#' @param type Type of MST plot to generate. Options are "basic" (no differential testing
#'   results), "DA" (shading to represent DA testing results), "DE" (shading to represent
#'   DE testing results). Default = "basic".
#' 
#' @param path Path to save plot. Default = current working directory.
#' 
#' 
#' @importFrom S4Vectors metadata
#' @importFrom SummarizedExperiment rowData
#' @importFrom ggplot2 ggplot aes geom_point coord_fixed ggtitle theme_bw ggsave
#'   scale_color_gradient
#' 
#' @export
#' 
#' @seealso \code{\link{testDA}} \code{\link{testDE_med}} \code{\link{testDE_FDA}}
#'   \code{\link{testDE_KS}} \code{\link{testDE_LM}}
#'
#' @examples
#' # See full examples in testing functions: testDA, testDE_med, testDE_FDA, testDE_KS,
#' # testDE_LM
#' 
plotMST <- function(d_se, d_counts, res_DA = NULL, 
                    type = c("basic", "DA", "DE"), path = ".") {
  
  mst <- metadata(d_se)$MST
  mst_coords <- mst$l
  
  if (!(nrow(mst_coords) == length(rowData(d_counts)$cluster))) {
    stop("minimum spanning tree (MST) does not have correct number of clusters")
  }
  
  n_cells <- rowData(d_counts)$n_cells
  
  d_plot <- data.frame(mst_coords)
  colnames(d_plot) <- c("MST_x", "MST_y")
  
  if (type == "basic") {
    ggplot(d_plot, aes(x = MST_x, y = MST_y, size = n_cells)) + 
      geom_point(alpha = 0.5, color = "darkblue") + 
      coord_fixed() + 
      ggtitle("FlowSOM clustering: Minimum spanning tree (MST)") + 
      theme_bw()
    
    ggsave(file.path(path, "MST_basic.pdf"), width = 7, height = 7)
  }
  
  if (type == "DA") {
    if (is.null(res_DA)) stop("'res_DA' object must be provided if 'type == 'DA''")
    
    p_adj_DA <- rowData(res_DA)$adj.P.Val
    d_plot <- cbind(d_plot, p_adj = p_adj_DA)
    
    min_val <- min(p_adj_DA)
    max_val <- max(p_adj_DA)
    
    ggplot(d_plot, aes(x = MST_x, y = MST_y, size = n_cells, color = p_adj)) + 
      geom_point(alpha = 0.5) + 
      scale_color_gradient(low = "red", high = "black", trans = "probit", 
                           breaks = c(min_val * 2, 0.05, max_val),  # multiply 'min_val' so it displays on legend
                           labels = c(round(min_val), 0.05, round(max_val))) + 
      coord_fixed() + 
      ggtitle("MST: Differential abundance (DA) test results") + 
      theme_bw()
    
    ggsave(file.path(path, "MST_results_DA.pdf"), width = 7, height = 7)
  }
}


